Base = require './base'
{getUnusedKey} = require './util'

module.exports = class Kite extends Base
  
  mq: null
  
  @share()

  @kites = {}

  @kitesById = {}

  @setSharedMethods
    instance: ['on','off','emit','once','many']

  @removeById =(id)->
    @emit 'kiteDidDisconnect', @kitesById[id]
    delete @kitesById[id]

  set:->

  constructor:(@api)->
    kite = @
    {constructor} = kite
    {kites, kitesById} = constructor
    {@id, @name, name} = api.bongo_

    kite.initializeSharedInstance api
    
    #
    # TBD kite.on 'ready' fires multiple times
    # need to investigate the cause and remove
    # unless kitesById[@id] line
    #
    
    unless kitesById[@id]
      kite.on 'ready', ->
        kites[name] = kite
        kitesById[@id] = kite      
        constructor.emit 'connect', name, kite

